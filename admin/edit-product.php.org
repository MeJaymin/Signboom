<?php 
  include ('authadmin.php'); 
  include ('helper-functions.php'); 
  mysql_select_db($database_DBConn, $DBConn) or die(mysql_error());

  // Get list of all categories in system. Include those which are NOT currently enabled  
  // on the regular order form so that we can assign finishing options to categories that 
  // are only offered to volume customers like TED/PDW through drag and drop interface.   
  $query_category = "SELECT code FROM signboom_category WHERE 1";
  $result_category = mysql_query($query_category, $DBConn) or die(mysql_error());
  $category_array = array();
  $j = 0;
  while ($row_category = mysql_fetch_array($result_category, MYSQL_BOTH))
  {
    $category_array[$j] = $row_category['code'];
    $j++;
  }

  $product_description = "";
  $product_descr_image = "";
  $product_descr_text = "";
  $product_descr_finishing = "";
  $product_descr_limitations = "";
  $product_descr_extras = "";
  $error_message = "";
  $created = false;
  $edited = false;
  $edit_mode = "edit";
  if (isset($_REQUEST['id']))
  {
    $product_id = $_REQUEST['id'];
    if (!isValidProductId($product_id))
    {
      echo "'$product_id' is not a valid product id. Please visit the <a href=\"products.php\">Products</a> page and click a product name.";
    }
    else 
    {
      if (isset($_POST['submit_edit_product'])) 
      {
        $product_name = mysql_real_escape_string($_POST['product_name']);
        $product_thickness = mysql_real_escape_string($_POST['product_thickness']);
        $product_uom_thickness = mysql_real_escape_string($_POST['product_uom_thickness']);
        $product_enabled = mysql_real_escape_string($_POST['product_enabled']);
        $product_category = mysql_real_escape_string($_POST['product_category']);
        $product_batch_day = mysql_real_escape_string($_POST['product_batch_day']);
        $product_description = mysql_real_escape_string($_POST['product_description']);
        $product_descr_image = mysql_real_escape_string($_POST['product_descr_image']);
        $product_descr_text= mysql_real_escape_string($_POST['product_descr_text']);
        $product_descr_finishing = mysql_real_escape_string($_POST['product_descr_finishing']);
        $product_descr_limitations = mysql_real_escape_string($_POST['product_descr_limitations']);
        $product_descr_extras = mysql_real_escape_string($_POST['product_descr_extras']);
        $product_width = mysql_real_escape_string($_POST['product_width']);
        $product_length = mysql_real_escape_string($_POST['product_length']);
        $product_cost_waste = mysql_real_escape_string($_POST['product_cost_waste']);
        $product_cost_non = mysql_real_escape_string($_POST['product_cost_non']);
        $product_cost_disc = mysql_real_escape_string($_POST['product_cost_disc']);
        $product_sort_group = mysql_real_escape_string($_POST['product_sort_group']);
        $product_sort_order = mysql_real_escape_string($_POST['product_sort_order']);

        if (!isValidProductName($product_name))
          $error_message = "'$product_name' is not a valid product name. Only letters, numbers, dashes, periods, spaces and () are allowed. The name must be between 4 and 64 characters long.";
	else if (!is_numeric($product_thickness))
          $error_message = "'$product_thickness' is not a valid value. Only integer and decimal numbers are allowed. Note: the thickness is given in mm.";
        else if (($product_uom_thickness != 'MM') && ($product_uom_thickness != 'IN') && ($product_uom_thickness != 'MIL') && ($product_uom_thickness != ''))
          $error_message = "'$product_uom_thickness' is not a valid value. Value must be either inches, mm,  mil or blank.";
        else if (strlen($product_enabled) == 0)
          $error_message = "You must indicate whether this product is to be enabled or not.";
        else if (strlen($product_category) == 0)
          $error_message = "You must choose a product category.";
/*
        else if (strlen(trim($product_description)) < 100)
          $error_message = "Your product description is too short.  Please provide a complete product description of at least 100 characters.";
        else if (strlen(trim($product_descr_text)) < 100)
          $error_message = "Your product description text is too short.  Please provide a complete product description of at least 100 characters.";
*/
        else if (!isValidDimension($product_width))
          $error_message = "'$product_width' is not a valid product dimension. The width must be given in inches, with only numbers and the period allowed.";
        else if (!isValidDimension($product_length))
          $error_message = "'$product_length' is not a valid product dimension. The length must be given in inches, with only numbers and the period allowed.";
        else if (!isValidCostFactor($product_cost_waste))
          $error_message = "'$product_cost_waste' is not a valid waste cost. The waste cost must be given in dollars and cents, with no dollar sign included.";
        else if (!isValidCostFactor($product_cost_non))
          $error_message = "'$product_cost_non' is not a valid non-discountable cost. The non-discountable cost must be given in dollars and cents, with no dollar sign included.";
        else if (!isValidCostFactor($product_cost_disc))
          $error_message = "'$product_cost_disc' is not a valid discountable cost. The discountable cost must be given in dollars and cents, with no dollar sign included.";
        else if (!isValidSortGroup($product_sort_group))
          $error_message = "'$product_sort_group' is not a valid sort group. Sort groups must be alphabetical only, and are typically one or two upper-case letters.";
        else if (!isValidSortOrder($product_sort_order))
          $error_message = "'$product_sort_order' is not a valid sort order. Sort orders must be numeric only and are typically from 1 to 99.";
 
        else
        {
          $query = "UPDATE signboom_allproducts SET Name = '$product_name', Thickness = '$product_thickness', Units = '$product_uom_thickness', Enabled = '$product_enabled', Category = '$product_category', BatchDay = $product_batch_day, Description = '$product_description',  DescriptionImage = '$product_descr_image', DescriptionText = '$product_descr_text', DescriptionFinishing = '$product_descr_finishing', DescriptionLimitations = '$product_descr_limitations', DescriptionExtras = '$product_descr_extras', Width = '$product_width', Length = '$product_length', CostWaste = '$product_cost_waste', CostNon = '$product_cost_non', CostDisc = '$product_cost_disc', SortGroup = '$product_sort_group', SortOrder = '$product_sort_order' WHERE Id = $product_id";
          //echo "Query: $query<br><br>";
          $result = mysql_query($query, $DBConn) or die(mysql_error());
          $edited = true;
        }
      }

      // Get the description of that product from the database.
      $query = "SELECT Id, Code, Thickness, Units, Name, Enabled, Category, BatchDay, Description, DescriptionImage, DescriptionText, DescriptionFinishing, DescriptionLimitations, DescriptionExtras, Width, Length, CostWaste, CostNon, CostDisc, SortGroup, SortOrder FROM signboom_allproducts WHERE Id = $product_id";
      $result = mysql_query($query, $DBConn) or die(mysql_error());
      $row = mysql_fetch_array($result, MYSQL_BOTH); 
      $product_code = $row['Code'];
      $product_name = $row['Name'];
      $product_thickness = $row['Thickness'];
      $product_uom_thickness = $row['Units'];
      $product_enabled= $row['Enabled'];
      $product_category = $row['Category'];
      $product_batch_day = $row['BatchDay'];
      $product_description = bbCode($row['Description']);
      $product_descr_image = bbCode($row['DescriptionImage']);
      $product_descr_text = bbCode($row['DescriptionText']);
      $product_descr_finishing = bbCode($row['DescriptionFinishing']);
      $product_descr_limitations = bbCode($row['DescriptionLimitations']);
      $product_descr_extras = bbCode($row['DescriptionExtras']);
      $product_width = $row['Width'];
      $product_length = $row['Length'];
      $product_cost_waste = $row['CostWaste'];
      $product_cost_non = $row['CostNon'];
      $product_cost_disc= $row['CostDisc'];
      $product_sort_group = $row['SortGroup'];
      $product_sort_order = $row['SortOrder'];
  
      // Display the product description in an editor. 
      include ('templates/edit-product.php'); 
  
      /* Free memory. */
      mysql_free_result($result);
    }
  }
  else
  {
    echo "You must specify a product id. Please visit the <a href=\"products.php\">Products</a> page and click a product name.";
  }

?>
